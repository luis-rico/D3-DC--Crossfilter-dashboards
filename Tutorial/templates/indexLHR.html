<!DOCTYPE html>
<html>
<head>
  <title>Dashboard Starter UI, by Keen IO</title>
  <link rel="stylesheet" type="text/css" href="/static/assets/lib/bootstrap/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="/static/assets/css/keen-dashboards.css" />
  <script type="text/javascript" src="https://rawgithub.com/NickQiZhu/dc.js/master/web/js/crossfilter.js"></script>
  <script src="/static/d3.min.js"></script>
  <link rel="stylesheet" type="text/css" href="http://cdnjs.cloudflare.com/ajax/libs/dc/1.7.0/dc.css" media="screen" /> 
  <script src="http://cdnjs.cloudflare.com/ajax/libs/dc/1.7.0/dc.js" type="text/javascript"></script>
</head>
<body class="application">

  <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container-fluid">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../">
          <span class="glyphicon glyphicon-chevron-left"></span>
        </a>
        <a class="navbar-brand" href="./">Waratah Train System Views data - Dashboard demo by Luis Rico Sep 2015</a>
      </div>
    </div>
  </div>

 
  
  <div class="container-fluid">
    <div class="row">

      <div class="col-sm-6">
        <div class="chart-wrapper">
          <div class="chart-title">
            Pageviews by browser (past 24 hours)
          </div>
          <div class="chart-stage" id="chart-line-amountperday">

          </div>
          <div class="chart-notes">
            This is a sample text region to describe this chart.
          </div>
        </div>
      </div>

      <div class="col-sm-6">
        <div class="chart-wrapper">
          <div class="chart-title">
            Pageviews by browser (past 5 days)
          </div>
          <div class="chart-stage">
            <img data-src="holder.js/100%x350/white">
          </div>
          <div class="chart-notes">
            Notes go down here
          </div>
        </div>
      </div>

    </div>


    <div class="row">

      <div class="col-sm-12">
        <div class="chart-wrapper">
          <div class="chart-title">
            Impressions by advertiser
          </div>
          <div class="chart-stage">
            <img data-src="holder.js/100%x150/white">
          </div>
          <div class="chart-notes">
            Notes go down here
          </div>
        </div>
      </div>

    </div>

    <hr>

    <p class="small text-muted">Built with &#9829; by <a href="https://keen.io">Keen IO</a></p>

  </div>

  <script type="text/javascript" src="/static/assets/lib/jquery/dist/jquery.min.js"></script>
  <script type="text/javascript" src="/static/assets/lib/bootstrap/dist/js/bootstrap.min.js"></script>

  <script type="text/javascript" src="/static/assets/lib/holderjs/holder.js"></script>
  <script>
    Holder.add_theme("white", { background:"#fff", foreground:"#a7a7a7", size:10 });
  </script>

  <script type="text/javascript" src="/static/assets/lib/keen-js/dist/keen.min.js"></script>
  <script type="text/javascript" src="/static/assets/js/meta.js"></script>

<script>
		
// This section defines a custom function that prints to console the value of an object.
		
		function print_filter(filter){
			var f=eval(filter);
			if (typeof(f.length) != "undefined") {}else{}
			if (typeof(f.top) != "undefined") {f=f.top(Infinity);}else{}
			if (typeof(f.dimension) != "undefined") {f=f.dimension(function(d) { return "";}).top(Infinity);}else{}
			console.log(filter+"("+f.length+") = "+JSON.stringify(f).replace("[","[\n\t").replace(/}\,/g,"},\n\t").replace("]","\n]"));
		} 

		//var data = [
		//	{"status":"http_302","hits":0,"date":"01/03/2013"},
	

	
		
	d3.tsv("/static/SystemViewsFaultsreduced_LHR_01.tsv", function (data) {	
		
			
		//console.log(data);
		
// Everything is imported as a string by default. Numeric column in read data must be converter to numeric
				
		var convert_2_int = function() {
			var max_length = data.length; 
				for (var i=0; i < max_length; i++) {
					data[i]["Num_Faults"] = parseInt(data[i]["Num_Faults"]);
				}
		}
		
		convert_2_int();
		
		console.log(data);

// Date format needs to be parsed and and the same time, an aggregate field can be processed

		
		var parseDate = d3.time.format("%d/%m/%Y").parse;  // LHR this is a function expression
			data.forEach(function(d) {		// LHR d only exists whilst forEach is being executed.
			d.Fault_Reported_Date = parseDate(d.Fault_Reported_Date);
			d.Year=d.Fault_Reported_Date.getFullYear();
		});
		
		console.log(data);


// Line chart code
		
		var ndx = crossfilter(data);
			
		var dateDim = ndx.dimension(function(d) {return d.Fault_Reported_Date;}); 
		
		var minDate = dateDim.bottom(1)[0].Fault_Reported_Date;
		var maxDate = dateDim.top(1)[0].Fault_Reported_Date;
		
		var amountlineChart  = dc.lineChart("#chart-line-amountperday");
		

		var Fault_Count=dateDim.group().reduceSum(function(d)
			{return d.Num_Faults;} );
		//var Holidays=dateDim.group().reduceSum(function(d)
		//	{if (d.Top_Discriminant==='Holidays') {return d.Amount;} else {return 0;}});
		//var House_Car_Loans=dateDim.group().reduceSum(function(d)
		//	{if (d.Top_Discriminant==='House & Car Loans') {return d.Amount;} else {return 0;}});
		//var Moving_to_Melbourne=dateDim.group().reduceSum(function(d)
		//	{if (d.Top_Discriminant==='Moving to Melbourne') {return d.Amount;} else {return 0;}});
		//var Non_Essentials=dateDim.group().reduceSum(function(d)
		//	{if (d.Top_Discriminant==='Non Essentials') {return d.Amount;} else {return 0;}});
		//var Non_Expenses=dateDim.group().reduceSum(function(d)
		//	{if (d.Top_Discriminant==='Non Expenses') {return d.Amount;} else {return 0;}});
			
		
		amountlineChart                       
			.width(500).height(200)
			.dimension(dateDim)
			.group(Fault_Count,"Fault Count")
			//.stack(Holidays,"Holidays")
			//.stack(House_Car_Loans,"Loans")
			//.stack(Moving_to_Melbourne,"Moving")
			//.stack(Non_Essentials,"Non Essentials")
			.renderArea(true)
			.x(d3.time.scale().domain([minDate,maxDate])) 
			//.brushOn(false)
			.legend(dc.legend().x(50).y(10).itemHeight(13).gap(5))
			.yAxisLabel("Fault Count");

// Ring chart code
			
		var yearRingChart   = dc.pieChart("#chart-ring-year");
		var yearDim  = ndx.dimension(function(d) {return +d.Year;});
		var year_total = yearDim.group().reduceSum(function(d) {return d.Num_Faults;});

		yearRingChart
			.width(150).height(150)
			.dimension(yearDim)
			.group(year_total)
			.innerRadius(30);

			
// Row chart code


		var classificationRowChart = dc.rowChart("#row-chart");
		var Classification = ndx.dimension(function(d) {return d.Classification;});
		var Faults_Classification = Classification.group().reduceSum(function(d) {return d.Num_Faults;});
		
	// rather than passing Faults_Classification directly to .group() within classificationRowChart, we generate a function that will filter the top 10 of the Faults_Classification group
		var filtered_group = filter_top(Faults_Classification);
		function filter_top(Faults_Classification) {
		  return {
			all:function () {
				return Faults_Classification.top(10);
				}
			}
		 }
		
			
	    classificationRowChart /* dc.rowChart('#day-of-week-chart', 'chartGroup') */
			.width(280)
			.height(300)
			.margins({top: 20, left: 10, right: 10, bottom: 20})
			.dimension(Classification)
			.group(filtered_group)
			//.group(Faults_Classification)  // No needed as we are having a filter for top 10, otherwise, usual group would have been passed as commented out
			.ordering(function(d) {return -d.value})
			
			//.ordinalColors(['#3182bd', '#6baed6', '#9ecae1', '#c6dbef', '#dadaeb'])
			//.colors(['#3182bd', '#6baed6', '#9ecae1', '#c6dbef', '#dadaeb'])
			//.label(function (d) {
			//	return d.key.split('.')[1];
			//})
			
			.title(function (d) {
				return d.value;
			})
			.elasticX(false)
			.xAxis().ticks(4);
			
		
// DataTable code	

	var datatable = dc.dataTable("#dc-data-table");
		
		var tableGroup = dateDim.group().reduce(
			function reduceAdd(p,v) {
				p[v.Classification] = v.Num_Faults;
				p["Year"] = v.Year;
				return p;
			},
			function reduceRemove(p,v) {
				p[v.Classification] = 0;
				p["Year"]=v.Year;
				
				return p;
			},
			function reduceInitial() {return {}; }
		);

		
		datatable
			.dimension(tableGroup)
			.group(function(d) {return d.value.Year;})
			// dynamic columns creation using an array of closures
			.columns([
				function(d) {return d.key.getDate() + "/" + (d.key.getMonth() + 1) + "/" + d.key.getFullYear(); },
				function(d) {return d.value.Trip;},
				function(d) {return d.value["Wheel & Axle"];},
				function(d) {return d.value["Semi Permanent Coupler"];},
				function(d) {return d.value.Body;},
				function(d) {return d.value["Lathe Activity Work Order"];},
				function(d) {return d.value.Windows;},
				function(d) {return d.value["Primary Suspension"];},
				function(d) {return d.value["Climate Control"];},
				function(d) {return d.value["Anti-Vandal Film"];},
				function(d) {return d.value.Internal;}
				//function(d) {return d.value.Trip+d.value["Wheel & Axle"]+d.value["Semi Permanent Coupler"]+d.value.Body+d.value["Lathe Activity Work Order"]+d.value.Windows+d.value["Primary Suspension"]+d.value["Climate Control"]+d.value["Anti-Vandal Film"]+d.value.Internal;}
			]);		
			
		dc.renderAll();
		
	});
			

 </script>

  
  
</body>



</html>
