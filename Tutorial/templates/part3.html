<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
		<meta http-equiv="content-type" content="text/html; charset=UTF8"> 
		<script type="text/javascript" src="https://rawgithub.com/NickQiZhu/dc.js/master/web/js/crossfilter.js"></script>
		<script src="/static/d3.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.js" type="text/javascript"></script>
		<link rel="stylesheet" type="text/css" href="http://cdnjs.cloudflare.com/ajax/libs/dc/1.7.0/dc.css" media="screen" /> 
		<script src="http://cdnjs.cloudflare.com/ajax/libs/dc/1.7.0/dc.js" type="text/javascript"></script>
    </head>
    <body>
        
	<div id="chart-line-hitsperday"></div>
	<div id="chart-ring-year"></div>
	<div id="chart-ring-status"></div>
	<div style='clear:both;'>
		<table id="dc-data-table">
			<thead>
			<tr class="header">
				<th>Day</th>
				<th>TPS 200</th>
				<th>TPS 302</th>
				<th>TPS Total</th>
			</tr>
			</thead>
		</table>

    <script>
		
		function print_filter(filter){
			var f=eval(filter);
			if (typeof(f.length) != "undefined") {}else{}
			if (typeof(f.top) != "undefined") {f=f.top(Infinity);}else{}
			if (typeof(f.dimension) != "undefined") {f=f.dimension(function(d) { return "";}).top(Infinity);}else{}
			console.log(filter+"("+f.length+") = "+JSON.stringify(f).replace("[","[\n\t").replace(/}\,/g,"},\n\t").replace("]","\n]"));
		} 

		var data = [
			{"status":"http_302","hits":0,"date":"01/03/2013"},
			{"status":"http_200","hits":90,"date":"01/03/2013"},
			{"status":"http_200","hits":200,"date":"01/07/2013"},
			{"status":"http_302","hits":1,"date":"01/06/2013"},
			{"status":"http_200","hits":200,"date":"01/06/2013"},
			{"status":"http_404","hits":2,"date":"01/06/2013"},
			{"status":"http_302","hits":0,"date":"01/05/2013"},
			{"status":"http_200","hits":90,"date":"01/05/2013"},
			{"status":"http_404","hits":2,"date":"01/05/2013"},
			{"status":"http_302","hits":0,"date":"01/04/2013"},
			{"status":"http_200","hits":90,"date":"01/04/2013"},
			{"status":"http_404","hits":2,"date":"01/04/2013"},
			{"status":"http_302","hits":100,"date":"01/07/2013"},
			{"status":"http_404","hits":1,"date":"01/07/2013"},
			{"status":"http_404","hits":2,"date":"01/03/2013"},
			{"status":"http_302","hits":1,"date":"01/02/2013"},
			{"status":"http_200","hits":10,"date":"01/02/2013"},
			{"status":"http_404","hits":1,"date":"01/02/2013"},
			{"status":"http_302","hits":0,"date":"01/01/2013"},
			{"status":"http_200","hits":90,"date":"01/01/2013"},
			{"status":"http_404","hits":2,"date":"01/01/2013"},
			{"status":"http_302","hits":0,"date":"12/31/2012"},
			{"status":"http_200","hits":90,"date":"12/31/2012"},
			{"status":"http_302","hits":100,"date":"12/27/2012"},
			{"status":"http_404","hits":2,"date":"12/27/2012"},
			{"status":"http_200","hits":90,"date":"12/30/2012"},
			{"status":"http_404","hits":2,"date":"12/30/2012"},
			{"status":"http_302","hits":200,"date":"12/29/2012"},
			{"status":"http_200","hits":300,"date":"12/29/2012"},
			{"status":"http_404","hits":1,"date":"12/29/2012"},
			{"status":"http_302","hits":100,"date":"12/28/2012"},
			{"status":"http_200","hits":10,"date":"12/28/2012"},
			{"status":"http_404","hits":2,"date":"12/28/2012"},
			{"status":"http_200","hits":190,"date":"12/27/2012"},
			{"status":"http_404","hits":2,"date":"12/31/2012"},
			{"status":"http_302","hits":0,"date":"12/30/2012"}
		]; 
		
		
		// LHR It should be noted that melt.js is not used. The tutorial gives an example on how to reformat the data should we are unable to reformat it.
		// LHR The data above is already in the new format so no need of melt.js
		
		console.log(data);

		
		var parseDate = d3.time.format("%m/%d/%Y").parse;  // LHR this is a function expression
		data.forEach(function(d) {		// LHR d only exists whilst forEach is being executed.
			d.date = parseDate(d.date);
			//d.total= d.http_404+d.http_200+d.http_302;
			d.Year=d.date.getFullYear();
		});
		
		
		var ndx = crossfilter(data);
		
		
		var dateDim = ndx.dimension(function(d) {return d.date;});   // LHR Not to be confused with a function expression. dateDim actually is executed
		
		var hits = dateDim.group().reduceSum(function(d) {return d.total;}); // note that this line can be commented out without consequences in lineChart below
		
		var yearRingChart   = dc.pieChart("#chart-ring-year");
		var yearDim  = ndx.dimension(function(d) {return +d.Year;});
		//var year_total = yearDim.group().reduceSum(function(d) {return d.total;});   // LHR we do not have total column anymore
		var year_total = yearDim.group().reduceSum(function(d) {return d.hits;});
		
		
		var minDate = dateDim.bottom(1)[0].date;
		var maxDate = dateDim.top(1)[0].date;
		
		var hitslineChart  = dc.lineChart("#chart-line-hitsperday");
		
		//var status_200=dateDim.group().reduceSum(function(d) {return d.http_200});
		//var status_302=dateDim.group().reduceSum(function(d) {return d.http_302});
		//var status_404=dateDim.group().reduceSum(function(d) {return d.http_404});
		var status_200=dateDim.group().reduceSum(function(d)
			{if (d.status==='http_200') {return d.hits;} else {return 0;}});
		var status_302=dateDim.group().reduceSum(function(d)
			{if (d.status==='http_302') {return d.hits;} else {return 0;}});
		var status_404=dateDim.group().reduceSum(function(d)
			{if (d.status==='http_404') {return d.hits;} else {return 0;}});
		
		hitslineChart                          // LHR note that hits is not used anymore (see part2.html)
			.width(500).height(200)
			.dimension(dateDim)
			.group(status_200,"200")
			.stack(status_302,"302")
			.stack(status_404,"404")
			.renderArea(true)
			.x(d3.time.scale().domain([minDate,maxDate])) 
			//.brushOn(false)
			.legend(dc.legend().x(50).y(10).itemHeight(13).gap(5))
			.yAxisLabel("Hits per day");

		yearRingChart
			.width(150).height(150)
			.dimension(yearDim)
			.group(year_total)
			.innerRadius(30);
			
			
		var statusRingChart = dc.pieChart("#chart-ring-status");
		var statusDim = ndx.dimension(function(d) {return d.status;});
		var hit_status = statusDim.group().reduceSum(function(d) {return d.hits;});
		
		statusRingChart
			.width(150).height(150)
			.dimension(statusDim)
			.group(hit_status)
			.innerRadius(30);
			

		var datatable = dc.dataTable("#dc-data-table");
		//datatable
		//	.dimension(dateDim)
		//	.group(function(d) {return d.Year;})
			//dynamic columns creation using an array of closures
		//	.columns([
		//		function(d) { return d.date.getDate() + "/" + (d.date.getMonth() + 1) + "/" + d.date.getFullYear();},
		//		function(d) { return d.http_200;},
		//		function(d) { return d.http_302;},
		//		function(d)	{ return d.http_404;},
		//		function(d)	{ return d.total;}
		//	]);
		
		var tableGroup = dateDim.group().reduce(
			function reduceAdd(p,v) {
				p[v.status] = v.hits;
				p["Year"] = v.Year;
				return p;
			},
			function reduceRemove(p,v) {
				p[v.status] = 0;
				p["Year"]=v.Year;
				
				return p;
			},
			function reduceInitial() {return {}; }
		);
		
		datatable
			.dimension(tableGroup)
			.group(function(d) {return d.value.Year;})
			// dynamic columns creation using an array of closures
			.columns([
				function(d) {return d.key.getDate() + "/" + (d.key.getMonth() + 1) + "/" + d.key.getFullYear(); },
				function(d) {return d.value.http_200;},
				function(d) {return d.value.http_302;},
				function(d) {return d.value.http_404;},
				function(d) {return d.value.http_200+d.value.http_302+d.value.http_404;}
			]);
			
		console.log(dateDim);
			
		dc.renderAll();
			

    </script>

    </body>
</html>